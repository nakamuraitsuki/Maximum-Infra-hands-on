## この章でやること
- キャッシュについての理解を深める

## 注意
前回の章からリポジトリの内容に変更が入っています。
もしv3.0.0より前のバージョンで遊んでいた方は、変更の反映をお願いします。
```bash
git stash
```
で、変更した環境変数を一時的にどけてから、
```bash
git pull
```
で、最新の状態を反映してください、そのあと
```bash
git stash apply
```
で、一時的にどけた環境変数設定が戻ります

また、Goのアプリケーションの内容をビルドし直す必要があります。
```bash
cd ~/Maximum-Infra-hands-on/backend
go build -o InfraHandsOn ./cmd/main.go
```

また、本章であつかうキャッシュですが、**導入にはメリットだけではなく、デメリットも存在します**

もし、個人開発などでの導入を考えている際には、検討の末、どうしてもキャッシュを入れたほうがメリットがある場合のみ入れることをおすすめします。

## キャッシュデータを保存する方法は複数ある。
キャッシュをすることによって、DBへのアクセス回数を減らしたりして負荷減少を狙うことがあります。

この返すキャッシュデータを保存する方法はいくつか選択肢がありますが、
- インメモリ（mapなど）を使う
- KVSを使う

の２つにまとめておきましょう。

KVS（Key Value Store）とは、シンプルなDBMS（DataBase Management System）のことで、KeyとValueを紐つけて保存します。

データは揮発性であることが多く、代わりにデータアクセスが非常に高速です。

代表的なKVSとしては、**Memcached** と **Redis** があります（これらのことをNoSQLとも呼びます）

一貫性を重視するRDBMSと、高速処理を実現するKVSを上手に使うと、負荷軽減が望める場合があります。

Memcachedは、かなり代表的なKVSです。

Redisは非常に多くの用途があるKVSです。

## キャッシュって難しい
キャッシュの導入は非常に難しい点があります。
- Thundering Herd 問題が発生し、Originへの負荷が高くなることがある。
- 古いデータや、意図しないデータが返答されてしまう可能性がある。

（Thundering Herd 問題：カンタンに言うと、chacheの作成のためにもリクエストが飛ぶため、キャッシュがまったくない再起動直後などに大量のリクエストが飛んでくると、クライアントのリクエスト＋キャッシュ生成のリクエストで、Originに非常に高い負荷がかかる問題）

など、実はデメリットも大きいのがキャッシュです。

DBの最適化などで対応できるなら、無理にキャッシュを導入する必要もないかもしれません。

## Memcacheを導入してみましょう。
この章では、現在インメモリで実装されているキャッシュをMemcacheに差し替えてみましょう。

```bash
sudo apt install memcached
```
でインストールできます。

インストールが完了すると自動的にmemcacheのサーバーが立ち上がります。

```bash
sudo systemctl status memcached
```
で、状態が確認できます。どのポートでリッスンしているかもわかります。

おそらくデフォルトでは`11211`ポートをリッスンしていると思います。

設定変更には`/etc/memcached.conf`を編集します。

例えば、キャッシュサーバーに外部からアクセスしたいとき、デフォルトではループバックのみを許可する設定になるので変える必要があります。

## Nさんが一晩でやってくれました。

**では早速、現在mapで実装されているGoアプリケーション実装を、Memcachedに置き換えていきましょう！！**

しかし、キャッシュの実装はメッセージの取得と保存でそれぞれ実装されていて、見つけるのが大変です。

しかも、Memcachedの実装においては、アプリケーション上の構造体をシリアライズしたりなどの処理が必要で少し大変です…

ご安心下さい。**偶然にも** このアプリケーションのバックエンドは技術の差し替えが非常にカンタンな設計にになっていて、Nさんが**環境変数を設定するだけで** キャッシュの実装が差し替わるように実装してくれました。

Memcachedのサーバーを立ち上げられたら、`/etc/systemd/system/InfraHandsOn.service`のEnvironmentをもう一つ作って、`MEMCACHED_ADDR`という環境変数にサーバーのアドレスとポートを設定してください。

```bash
Environment=MYSQL_DSN=....
↓
Environment=MYSQL_DSN=.....
Environment=MEMCACHED_ADDR=localhost:11211
```

これができたら、サービスのファイルを読み込ませた上で再起動をしましょう。

```bash
sudo systemctl daemon-reload
sudo systemctl restart InfraHandsOn.service
```

ここまでできたら、
```bash
sudo systemctl status InfraHandsOn
```
で、状態を確認しましょう。

無事動いていて、ログにMemcachedに関するものが出ていたら、おめでとうございます。成功です！！

お疲れ様でした。